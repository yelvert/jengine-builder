var scripts = module.exports = {};
var packageJSON = require('../package.json');
var U = require('underscore');
var fs = require('fs');
var path = require('path');
var logger = require('logger');
var jengineRoot = path.normalize(path.join(__dirname, '..'));
var readFile = function(filename, templateObject) {
  var file = fs.readFileSync(path.normalize(path.join(jengineRoot, filename))).toString();

  if (U.isObject(templateObject)) {
    file = U.template(file, templateObject);
  }
  return file;
};

scripts.compile = function() {
  var files = packageJSON.files;
  // var utilFiles = U.detect(files, function(file) {return (new RegExp('^src\/utils(.js$|\/.*)', 'i')).test(file)});
  // files = U.without(files, utilFiles);
  
  var script = [];
  script.push(readFile('./header.js', {VERSION: packageJSON.version}));
  U.each(files, function(file) {
    var fileStr = "(function() {";
    fileStr += readFile(file);
    fileStr += '})();';
    script.push(fileStr);
  });
  script.push(readFile('./footer.js'));
  return script.join("\n\n");
};

scripts.build = function() {
  var script = scripts.compile();
  fs.writeFileSync(path.join(jengineRoot, 'jengine.js'), script);
  return script;
};