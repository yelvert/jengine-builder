var Scene = JEngine.Scene = JEngine.Utils.Obj.extend({
  constructor: function(game, scene, options) {
    if (this instanceof JEngine.Scene) {
      this._super(options);
      this.game = game;
      this.gameObjects = [];
      this.setManifest(scene);
    } else {
      if (scene instanceof JEngine.Scene) {
        scene.game = game;
        return scene;
      } else {
        return new JEngine.Scene(game, scene, options);
      }
    }
  },

  setManifest: function(scene) {
    if (scene) {
      if (_.isObject(scene)) {
        this.manifest = scene;
        this.load();
      } else {
        var self = this;
        this.game.getJSON('scene', scene, function(json) {
          self.manifest = json;
          self.load();
        });
      }
    } else {
      this.load();
    }
  },

  load: function() {
    console.log(this.manifest);
    this.fixedFrameRate = this.manifest.fixedFrameRate || 30;
    return this;
  },

  start: function() {
    if (!this.game) throw new Error('JEngine Scene cannot start without a game.');
    var self = this;
    var lastUpdateFrameTime = (new Date).valueOf();
    var lastFixedUpdateFrameTime = lastUpdateFrameTime;
    self.updateLoop = setInterval(function() {
      var newUpdateFrameTime = (new Date).valueOf();
      var frameTime = newUpdateFrameTime - lastUpdateFrameTime;
      lastUpdateFrameTime = newUpdateFrameTime;
      _.each(self.gameObjects, function(gameObject) {
        gameObject.trigger('update', frameTime);
      });
      // this.draw();
    }, 0);
    self.fixedUpdateLoop = setInterval(function() {
      var newFixedUpdateFrameTime = (new Date).valueOf();
      var frameTime = newFixedUpdateFrameTime - lastFixedUpdateFrameTime;
      lastFixedUpdateFrameTime = newFixedUpdateFrameTime;
      _.each(self.gameObjects, function(gameObject) {
        gameObject.trigger('fixedUpdate', frameTime);
      });
      // this.draw();
    }, 1000 / self.fixedFrameRate);
    return self;
  }
}, {
  Load: function(scene, options) {
    return JEngine.Scene(false, scene, options);
  }
});