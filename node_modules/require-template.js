var fs = require('fs'),
  path = require('path'),
  U = require('underscore');

var requireTemplate = module.exports = function (template) {
  var templatePath = requireTemplate.resolve(template);
  if (templatePath) {
    var file = fs.readFileSync(templatePath).toString();
    return U.template(file);
  } else {
    throw new Error('Cannot find template ' + template + '!');
  }
};

U.extend(requireTemplate, {
  resolve: function (template) {
    var pathEnd = template + '.' + requireTemplate.extension;
    var fullPath;
    U.detect(requireTemplate.paths, function (pathStart) {
      var testPath = path.join(process.cwd(), pathStart, pathEnd);
      if (fs.existsSync(testPath) && fs.lstatSync(testPath).isFile()) {
        fullPath = testPath;
        return true;
      }
    });
    return fullPath;
  },

  addPath: function () {
    U.chain(arguments).slice().flatten().values().forEach(function (newPath) {
      requireTemplate.paths.push(newPath);
    });
    requireTemplate.paths = U.uniq(requireTemplate.paths);
    return requireTemplate.paths;
  },

  paths: [],

  extension: 'jst'
});